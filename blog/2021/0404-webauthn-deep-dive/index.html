<!doctype html><html lang=ja><head><meta charset=utf-8><title>WebAuthn DeepDive #2 - Attestation - Shukawam's Daily Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=180x180 href="/blog/favicon/apple-touch-icon.png?v=1"><link rel=icon type=image/png sizes=32x32 href="/blog/favicon/favicon-32x32.png?v=1"><link rel=icon type=image/png sizes=16x16 href="/blog/favicon/favicon-16x16.png?v=1"><link rel=manifest href="/blog/favicon/site.webmanifest?v=1"><link rel=mask-icon href="/blog/favicon/safari-pinned-tab.svg?v=1" color=#ffffff><link rel="shortcut icon" href="/blog/favicon/favicon.ico?v=1"><meta name=msapplication-config content="/blog/favicon/browserconfig.xml?v=1"><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><meta name=generator content="Hugo 0.74.2"><meta property="og:site_name" content="Shukawam's Daily Blog"><meta property="og:title" content="WebAuthn DeepDive #2 - Attestation"><meta property="og:description" content="Shukawam's Daily Blog."><meta property="description" content="Shukawam's Daily Blog."><meta property="og:url" content="https://shukawam.github.io/blog/blog/2021/0404-webauthn-deep-dive/"><meta property="og:type" content="article"><meta property="og:image" content="https://shukawam.github.io/blog/img/2021/0323/webauthn1-960x480.png"><meta property="og:image:alt" content="webauthn"><link rel=stylesheet href=/blog/css/bundle.min.d9e04ae08c9b3049b766dbd4aeab7d862c5ea1d13679b621490e0f5df5507497.css integrity="sha256-2eBK4IybMEm3ZtvUrqt9hixeodE2ebYhSQ4PXfVQdJc="><link rel=stylesheet href=/blog/css/add-on.css></head><body><header id=site-header><nav id=site-nav><h1 class=nav-title><a href=/blog/ class=nav>ブログ</a></h1><menu id=site-nav-menu class="flyout-menu menu"><a href=/blog/ class="nav link"><i class="fa fa-home"></i>Home</a>
<a href=#share-menu class="nav link share-toggle"><i class="fas fa-share-alt">&nbsp;</i>Share</a>
<a href=#search-input class="nav link search-toggle"><i class="fas fa-search">&nbsp;</i>Search</a></menu>
<a href=#search-input class="nav search-toggle"><i class="fas fa-search fa-2x">&nbsp;</i></a>
<a href=#share-menu class="nav share-toggle"><i class="fas fa-share-alt fa-2x">&nbsp;</i></a>
<a href=#lang-menu class="nav lang-toggle" lang=ja>ja</a>
<a href=#site-nav class="nav nav-toggle"><i class="fas fa-bars fa-2x"></i></a></nav><menu id=search class=menu><input id=search-input class="search-input menu"></input><div id=search-results class="search-results menu"></div></menu><menu id=lang-menu class="flyout-menu menu"><a href=# lang=ja class="nav link active">日本語 (ja)</a></menu>
<menu id=share-menu class="flyout-menu menu"><h1>Share Post</h1><a href="//twitter.com/share?text=WebAuthn%20DeepDive%20%232%20-%20Attestation&url=https%3a%2f%2fshukawam.github.io%2fblog%2fblog%2f2021%2f0404-webauthn-deep-dive%2f" target=_blank rel=noopener class="nav share-btn twitter"><p>Twitter</p></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fshukawam.github.io%2fblog%2fblog%2f2021%2f0404-webauthn-deep-dive%2f" target=_blank rel=noopener class="nav share-btn facebook"><p>Facebook</p></a><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fshukawam.github.io%2fblog%2fblog%2f2021%2f0404-webauthn-deep-dive%2f&title=WebAuthn%20DeepDive%20%232%20-%20Attestation" target=_blank rel=noopener class="nav share-btn linkedin"><p>LinkedIn</p></a></menu></header><div id=wrapper><section id=site-intro><a href=/blog/><img src=https://shukawam.github.io/blog/img/main/shukawam.jpg class=circle width=100 alt="Shuhei, Kawamura"></a><header><h1>Shuhei, Kawamura</h1></header><main><p>Solutions Engineer at @Oracle_Japan.</p></main><footer><ul class=socnet-icons><li><a href=//github.com/shukawam target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//twitter.com/shukawam target=_blank rel=noopener title=Twitter class="fab fa-twitter"></a></li></ul></footer></section><main id=site-main><article class=post><header><div class=title><h2><a href=/blog/blog/2021/0404-webauthn-deep-dive/>WebAuthn DeepDive #2 - Attestation</a></h2></div><div class=meta><time datetime="2021-04-05 00:00:00 +0000 UTC">2021-04-05</time><p>Shuhei, Kawamura</p><p>2 分で読めます</p></div></header><div id=socnet-share><a href="//twitter.com/share?text=WebAuthn%20DeepDive%20%232%20-%20Attestation&url=https%3a%2f%2fshukawam.github.io%2fblog%2fblog%2f2021%2f0404-webauthn-deep-dive%2f" target=_blank rel=noopener class="nav share-btn twitter"><p>Twitter</p></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fshukawam.github.io%2fblog%2fblog%2f2021%2f0404-webauthn-deep-dive%2f" target=_blank rel=noopener class="nav share-btn facebook"><p>Facebook</p></a><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fshukawam.github.io%2fblog%2fblog%2f2021%2f0404-webauthn-deep-dive%2f&title=WebAuthn%20DeepDive%20%232%20-%20Attestation" target=_blank rel=noopener class="nav share-btn linkedin"><p>LinkedIn</p></a></div><div class=content><a href=/blog/blog/2021/0404-webauthn-deep-dive/ class=image style="--bg-image: url('https://shukawam.github.io/blog/img/2021/0323/webauthn1-960x480.png')"><img src=https://shukawam.github.io/blog/img/2021/0323/webauthn1-960x480.png alt=webauthn></a><h1 id=始めに>始めに</h1><p><a href=https://webauthn.io/>WebAuthn</a> について学習したときのメモ。今回は、<a href=https://www.w3.org/TR/webauthn-1/#sctn-attestation>Attestation</a> についてです。</p><h1 id=about-attestation>About Attestation</h1><p>雑に言うと、FIDO2 のユーザー登録フローにおいて認証器で非対称の鍵ペア(秘密鍵、公開鍵)が生成されるが、その公開鍵がきちんと FIDO2 認証ベンダーの認証器から生成されたものか？どうかを検証する仕組みのこと。認証器は出荷時に FIDO2 認定ベンダーより認証器内のセキュア領域にベンダー固有の秘密鍵を埋め込まれるが、その秘密鍵でユーザー登録時に生成した公開鍵に対して署名を行う。最終的に RP(Relying Party)では、その署名をベンダー固有の公開鍵(ルート証明書)を用いる事で検証し、送信されてきた公開鍵の妥当性を検証することでユーザーの登録可否を決定する。</p><h1 id=deep-dive>Deep Dive</h1><p>まずは、原文を読んでみましょう。</p><blockquote><p>Authenticators MUST also provide some form of attestation. The basic requirement is that the authenticator can produce, for each credential public key, an attestation statement verifiable by the WebAuthn Relying Party. Typically, this attestation statement contains a signature by an attestation private key over the attested credential public key and a challenge, as well as a certificate or similar data providing provenance information for the attestation public key, enabling the Relying Party to make a trust decision. However, if an attestation key pair is not available, then the authenticator MUST perform self attestation of the credential public key with the corresponding credential private key. All this information is returned by authenticators any time a new public key credential is generated, in the overall form of an attestation object. The relationship of the attestation object with authenticator data (containing attested credential data) and the attestation statement is illustrated in figure 5, below.</p></blockquote><p>雑に訳すと、</p><ul><li>Authenticator(認証器)は、何らかの認証を提供する必要がある(生成した公開鍵の出所を証明すること)</li><li>Authenticator(認証器)の満たすべき基本的な要件は以下<ul><li>クレデンシャル公開鍵(登録時に生成される公開鍵)について、WebAuthn RP が検証可能な証明書(<code>attestation statement</code>)を作成できる事</li><li><code>attestation statement</code>には以下の情報を含む(RP はこれらの情報を用いて、公開鍵の出所の妥当性を検証を行う)<ul><li>FIDO2 認証ベンダーから認証器内のセキュア領域に埋め込まれた秘密鍵によって生成された署名</li><li>RP から発行された challenge</li><li>公開鍵の出所情報を提供する証明書(もしくはそれに値する情報)</li></ul></li></ul></li></ul><p>となる。何となく、FIDO2 における Attestation がどういうものだか分かってきたので、WebAuthn 実行後に認証器から返却されるデータを振り返ってみましょう。こんなデータが返ってきます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt>{
  &#34;id&#34;: &#34;xTzphZPuJyfW12TAT…&#34;,
  &#34;rawId&#34;: ArrayBuffer(64) {},
  &#34;response&#34;: {
    &#34;attestationObject&#34;: ArrayBuffer(1024),
    &#34;clientDataJSON&#34;: ArrayBuffer(116) {}
  },
  &#34;type&#34;: &#34;public-key&#34;
}
</code></pre></div><p>今回ちゃんと仕様を読んでいくのは、このうち<code>attestationObject</code>ということになります。</p><h2 id=attestation-object>Attestation Object</h2><p><code>attestationObject</code>は、CBOR<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>で表現されており、W3C で仕様が公開されています。具体的には以下の通り。</p><p><img src=https://shukawam.github.io/blog/img/2021/0404/attestation-object.png alt=attestation-object></p><p>もう少し、開発者に分かりやすく JSON 形式で表現すると以下のようになる。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>[
  {
    <span style=color:#f92672>&#34;fmt&#34;</span>: <span style=color:#e6db74>&#34;packed&#34;</span>,
    <span style=color:#f92672>&#34;attStmt&#34;</span>: {
      <span style=color:#f92672>&#34;alg&#34;</span>: <span style=color:#ae81ff>-7</span>,
      <span style=color:#f92672>&#34;sig&#34;</span>: {
        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;Buffer&#34;</span>,
        <span style=color:#f92672>&#34;data&#34;</span>: <span style=color:#e6db74>&#34;...&#34;</span>
      },
      <span style=color:#f92672>&#34;x5c&#34;</span>: [
        {
          <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;Buffer&#34;</span>,
          <span style=color:#f92672>&#34;data&#34;</span>: <span style=color:#e6db74>&#34;...&#34;</span>
        }
      ]
    },
    <span style=color:#f92672>&#34;authData&#34;</span>: {
      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;Buffer&#34;</span>,
      <span style=color:#f92672>&#34;data&#34;</span>: <span style=color:#e6db74>&#34;...&#34;</span>
    }
  }
]
</code></pre></div><p>各プロパティ内に含まれるバイナリデータまで見ていきましょう。</p><h3 id=fmt>fmt</h3><p><a href=https://www.w3.org/TR/webauthn/#sctn-defined-attestation-formats>Defined Attestation Statement Formats</a>によると、以下の種類があるそうです。</p><table><thead><tr><th>Format</th><th>Attestation Support Type</th><th>説明</th></tr></thead><tbody><tr><td><a href=https://www.w3.org/TR/webauthn/#sctn-packed-attestation>Packed</a></td><td>Basic, Self, AttCA</td><td>WebAuthn に最適化されたフォーマット</td></tr><tr><td><a href=https://www.w3.org/TR/webauthn/#sctn-tpm-attestation>TPM</a></td><td>AttCA</td><td>Trusted Platform Module を暗号エンジンとして使用する認証器で使用される</td></tr><tr><td><a href=https://www.w3.org/TR/webauthn/#sctn-android-key-attestation>Android Key</a></td><td>Basic</td><td>対象となる認証器が Android N(Nougat) 移行のプラットフォーム認証器の場合に使用される</td></tr><tr><td><a href=https://www.w3.org/TR/webauthn/#sctn-android-safetynet-attestation>Android SafetyNet</a></td><td>Basic</td><td>認証器が特定の Android プラットフォーム上の認証器の場合、SafetyNet API に基づいても良い</td></tr><tr><td><a href=https://www.w3.org/TR/webauthn/#sctn-fido-u2f-attestation>FIDO U2F</a></td><td>Basic, AttCA</td><td>FIDO U2F 認証器で使用される</td></tr><tr><td><a href=https://www.w3.org/TR/webauthn/#sctn-none-attestation>None</a></td><td>None</td><td>Relying Party が認証情報を受け取ることを希望しない場合に使用する</td></tr><tr><td><a href=https://www.w3.org/TR/webauthn/#sctn-apple-anonymous-attestation>Apple Anonymous</a></td><td>Anonymization CA</td><td>Apple が WebAuthn をサポートする特定の種類の Apple デバイスに対して独占的に使用される</td></tr></tbody></table><p>上の Attestation Object の構造の所で先出ししてしまいましたが、今回は<code>Packed</code>の場合のみ取り扱います。</p><h3 id=attedted-credential-data>Attedted Credential Data</h3><p>下図の赤枠でかこっている箇所の話です。</p><p><img src=https://shukawam.github.io/blog/img/2021/0404/attested_credential_data.png alt=attested-credential-data></p><p><code>authData</code>内に含まれる Attested Credential Data は、以下のような構成になっています。</p><table><thead><tr><th>プロパティ名</th><th>バイト長</th><th>説明</th></tr></thead><tbody><tr><td>aaguid</td><td>16</td><td>認証器のタイプを示す 128bit(16byte)の識別子のこと</td></tr><tr><td>credentialIdLength</td><td>2</td><td>クレデンシャル ID のバイト長を示す 16bit(2byte)の符号なしビッグエンディアン整数</td></tr><tr><td>credentialId</td><td>L</td><td>クレデンシャルを一意に識別する ID</td></tr><tr><td>credentialPublicKey</td><td>variable</td><td>COSE_Key 形式でエンコードされたクレデンシャル公開鍵(認証器で生成された公開鍵)</td></tr></tbody></table><p>ここに COSE_Key 形式でエンコードされた以降の認証フローで使用するための公開鍵が含まれているので、検証終了時に Database で永続化しておきます。</p><h3 id=attstmt>attStmt</h3><p>下図の赤枠でかこっている箇所の話です。</p><p><img src=https://shukawam.github.io/blog/img/2021/0404/att-stmt.png alt=attStmt></p><p>何やら、FIDO2 認証ベンダーの秘密鍵によって生成された署名や証明書が含まれていそうです。きちんとプロパティを見ていくと、以下のようになっています。(今回は Basic の場合)</p><table><thead><tr><th>プロパティ名</th><th>説明</th></tr></thead><tbody><tr><td>alg</td><td>COSE Algorithm Identifier で指定する sig(署名)の暗号化アルゴリズム</td></tr><tr><td>sig</td><td>FIDO 認証ベンダー固有の秘密鍵によって生成された署名</td></tr><tr><td>x5c</td><td>attestnCert (とその証明書チェーン)が含まれていて、それぞれ X.509 形式でエンコードされている</td></tr></tbody></table><p>署名の検証手順については、<a href=https://www.w3.org/TR/webauthn/#sctn-attestation-formats>6.5.2. Attestation Statement Formats</a>に記されています。(OSS のライブラリの開発などやフルスクラッチで実装しようという方以外は知らなくても大丈夫な部分かと思われます)</p><h1 id=参考>参考</h1><ul><li><a href=https://www.w3.org/TR/webauthn/>W3C WebAuthn</a></li></ul><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>Concise Binary Object Representation (CBOR)の略で、バイナリの JSON のようなもの <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div><footer><div class=stats><ul class=categories><li><a class=article-terms-link href=/blog/categories/tech/>tech</a></li></ul><ul class=tags><li><a class=article-terms-link href=/blog/tags/webauthn/>WebAuthn</a></li><li><a class=article-terms-link href=/blog/tags/ctap/>CTAP</a></li></ul></div></footer></article><article class=post><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"shukawam"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article><div class=pagination><a href=/blog/blog/2021/0406-webauthn-tips/ class="button left"><span>FIDO2 Tips & Considering</span></a>
<a href=/blog/blog/2021/0324-webauthn-deep-dive/ class="button right"><span>WebAuthn DeepDive #1 - navigator.credentials.create()</span></a></div></main><section id=site-sidebar><section id=recent-posts><header><h1>最近の投稿</h1></header><article class=mini-post><a href=/blog/blog/2021/0406-webauthn-tips/ class=image style="--bg-image: url('https://shukawam.github.io/blog/img/2021/0406/fido2.png')"><img src=https://shukawam.github.io/blog/img/2021/0406/fido2.png alt=webauthn></a><header><h2><a href=/blog/blog/2021/0406-webauthn-tips/>FIDO2 Tips & Considering</a></h2><time class=published datetime="2021-04-06 00:00:00 +0000 UTC">2021-04-06</time></header></article><article class=mini-post><a href=/blog/blog/2021/0404-webauthn-deep-dive/ class=image style="--bg-image: url('https://shukawam.github.io/blog/img/2021/0323/webauthn1-960x480.png')"><img src=https://shukawam.github.io/blog/img/2021/0323/webauthn1-960x480.png alt=webauthn></a><header><h2><a href=/blog/blog/2021/0404-webauthn-deep-dive/>WebAuthn DeepDive #2 - Attestation</a></h2><time class=published datetime="2021-04-05 00:00:00 +0000 UTC">2021-04-05</time></header></article><article class=mini-post><a href=/blog/blog/2021/0324-webauthn-deep-dive/ class=image style="--bg-image: url('https://shukawam.github.io/blog/img/2021/0323/webauthn1-960x480.png')"><img src=https://shukawam.github.io/blog/img/2021/0323/webauthn1-960x480.png alt=webauthn></a><header><h2><a href=/blog/blog/2021/0324-webauthn-deep-dive/>WebAuthn DeepDive #1 - navigator.credentials.create()</a></h2><time class=published datetime="2021-03-24 00:00:00 +0000 UTC">2021-03-24</time></header></article><article class=mini-post><a href=/blog/blog/2021/0322-spring-boot-native-image/ class=image style="--bg-image: url('https://shukawam.github.io/blog/img/2021/0323/OG-Spring.png')"><img src=https://shukawam.github.io/blog/img/2021/0323/OG-Spring.png alt></a><header><h2><a href=/blog/blog/2021/0322-spring-boot-native-image/>Spring Native Getting Started</a></h2><time class=published datetime="2021-03-22 00:00:00 +0000 UTC">2021-03-22</time></header></article><article class=mini-post><a href=/blog/blog/2021/0212-helidon-se-components/ class=image style="--bg-image: url('https://shukawam.github.io/blog/img/2021/0206/helidon.jpg')"><img src=https://shukawam.github.io/blog/img/2021/0206/helidon.jpg alt=helidon.jpg></a><header><h2><a href=/blog/blog/2021/0212-helidon-se-components/>Helidon SE Component - Config, OpenAPI</a></h2><time class=published datetime="2021-02-08 00:00:00 +0000 UTC">2021-02-08</time></header></article><footer><a href=/blog/blog class=button>続きを見る</a></footer></section><section id=categories><header><h1><a href=/blog/categories>カテゴリー</a></h1></header><ul><li><a href=/blog/categories/tech/>tech<span class=count>8</span></a></li></ul></section></section><footer id=site-footer><ul class=socnet-icons><li><a href=//github.com/shukawam target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//twitter.com/shukawam target=_blank rel=noopener title=Twitter class="fab fa-twitter"></a></li></ul><p class=copyright>© 2021 Shukawam's Daily Blog<br>Theme: <a href=https://github.com/pacollins/hugo-future-imperfect-slim target=_blank rel=noopener>Hugo Future Imperfect Slim</a><br>A <a href=https://html5up.net/future-imperfect target=_blank rel=noopener>HTML5 UP port</a> | Powered by <a href=https://gohugo.io/ title=0.74.2 target=_blank rel=noopener>Hugo</a></p></footer><a id=back-to-top href=# class="fas fa-arrow-up fa-2x"></a><script src=/blog/js/highlight.js></script><script>hljs.initHighlightingOnLoad();</script><script src=/blog/js/bundle.min.9ff362e34d745f104d2d4c4f7cc44e803472c83258fff84852e7d418014b25c3.js integrity="sha256-n/Ni4010XxBNLUxPfMROgDRyyDJY//hIUufUGAFLJcM="></script><script src=/blog/js/add-on.js></script></div></body></html>