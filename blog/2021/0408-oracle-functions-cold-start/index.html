<!doctype html><html lang=en-us><head><title>Oracle FunctionsのCold Start対策 // Shukawam's Daily Blog</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.74.2"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Shuhei Kawamura"><meta name=description content><link rel=stylesheet href=https://shukawam.github.io/blog/css/main.min.8319a554a1447263053ca3a53200e173393626a2b845544492b7de792c2e9412.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','G-4W6XCC73C8','auto');ga('send','pageview');}</script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content><meta name=twitter:title content="Oracle FunctionsのCold Start対策"><meta name=twitter:description content="始めに OCI の FaaS サービスである Functions の Cold Start の対策をメモしておく。将来的に事前暖機の機能等がリリースされた場合、本記事はアンチパターンとなる可能性があることをご了承の上参照してください。(あくまで、2021/04/08 現在取りえる手法として書きます)
Functions の定期実行 この手のサービスではよくとられてきた手法ですが、Functions に適当なエンドポイントを用意して定期的に実行するというものです。コンテナが落ちるまでの具体的な時間は不明ですが、感覚的に 15 ~ 20 分といった所なので 10 分に一回叩けば問題ないと思います。現在、Functions 自体に定期実行するような機能は存在しないので外部から実行してあげる必要がありますが、具体的に取りえる方法としては以下の通り。(他にもあるかもしれないですが&mldr;)
 適当な Compute Instance から CLI や SDK、署名付きの HTTP エンドポイントを定期的に叩く OCI Monitoring の Health Check を使用する  一つずつ簡単に紹介します。
適当な Compute Instance から定期実行する こちらは、特に解説不要かな、、cron でも書いて適当に叩いてください。
OCI Monitoring の Health Check 機能を使用する Health Check のエンドポイントを持つ Functions を作成する fn init --runtime java11 fn-hello 一つの Functions に対して、API Gateway でエンドポイントを複数作成し、そのパスで分岐処理するパターンです。
今回は、
 /cold/hello: Hello, world という文字列を返却するエンドポイント /cold/health: 定期実行用の常に{&#34;status&#34;: &#34;UP&#34;}を返却するエンドポイント  といった形で作ってみました。"><meta property="og:title" content="Oracle FunctionsのCold Start対策"><meta property="og:description" content="始めに OCI の FaaS サービスである Functions の Cold Start の対策をメモしておく。将来的に事前暖機の機能等がリリースされた場合、本記事はアンチパターンとなる可能性があることをご了承の上参照してください。(あくまで、2021/04/08 現在取りえる手法として書きます)
Functions の定期実行 この手のサービスではよくとられてきた手法ですが、Functions に適当なエンドポイントを用意して定期的に実行するというものです。コンテナが落ちるまでの具体的な時間は不明ですが、感覚的に 15 ~ 20 分といった所なので 10 分に一回叩けば問題ないと思います。現在、Functions 自体に定期実行するような機能は存在しないので外部から実行してあげる必要がありますが、具体的に取りえる方法としては以下の通り。(他にもあるかもしれないですが&mldr;)
 適当な Compute Instance から CLI や SDK、署名付きの HTTP エンドポイントを定期的に叩く OCI Monitoring の Health Check を使用する  一つずつ簡単に紹介します。
適当な Compute Instance から定期実行する こちらは、特に解説不要かな、、cron でも書いて適当に叩いてください。
OCI Monitoring の Health Check 機能を使用する Health Check のエンドポイントを持つ Functions を作成する fn init --runtime java11 fn-hello 一つの Functions に対して、API Gateway でエンドポイントを複数作成し、そのパスで分岐処理するパターンです。
今回は、
 /cold/hello: Hello, world という文字列を返却するエンドポイント /cold/health: 定期実行用の常に{&#34;status&#34;: &#34;UP&#34;}を返却するエンドポイント  といった形で作ってみました。"><meta property="og:type" content="article"><meta property="og:url" content="https://shukawam.github.io/blog/blog/2021/0408-oracle-functions-cold-start/"><meta property="og:image" content><meta property="article:published_time" content="2021-04-08T00:00:00+00:00"><meta property="article:modified_time" content="2021-04-08T00:00:00+00:00"></head><body><header class=app-header><a href=https://shukawam.github.io/blog><img class=app-header-avatar src=/blog/img/main/shukawam.jpg alt="Shuhei Kawamura"></a><h1>Shukawam's Daily Blog</h1><nav class=app-header-menu><a class=app-header-menu-item href=/blog/>Home</a>
-
<a class=app-header-menu-item href=/blog/tags/>Tags</a></nav><p>I'm Solutions Engineer at Oracle Japan. These articles are just my opinions.</p><div class=app-header-social><a href=https://github.com/shukawam target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>Github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://twitter.com/shukawam target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter"><title>Twitter</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Oracle FunctionsのCold Start対策</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Apr 8, 2021</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>2 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://shukawam.github.io/blog/tags/oci/>OCI</a>
<a class=tag href=https://shukawam.github.io/blog/tags/functions/>Functions</a>
<a class=tag href=https://shukawam.github.io/blog/tags/java/>java</a></div></div></header><div class=post-content><h1 id=始めに>始めに</h1><p>OCI の FaaS サービスである Functions の Cold Start の対策をメモしておく。将来的に事前暖機の機能等がリリースされた場合、本記事はアンチパターンとなる可能性があることをご了承の上参照してください。(あくまで、2021/04/08 現在取りえる手法として書きます)</p><h1 id=functions-の定期実行>Functions の定期実行</h1><p>この手のサービスではよくとられてきた手法ですが、Functions に適当なエンドポイントを用意して定期的に実行するというものです。コンテナが落ちるまでの具体的な時間は不明ですが、感覚的に 15 ~ 20 分といった所なので 10 分に一回叩けば問題ないと思います。現在、Functions 自体に定期実行するような機能は存在しないので外部から実行してあげる必要がありますが、具体的に取りえる方法としては以下の通り。(他にもあるかもしれないですが&mldr;)</p><ul><li>適当な Compute Instance から CLI や SDK、署名付きの HTTP エンドポイントを定期的に叩く</li><li>OCI Monitoring の Health Check を使用する</li></ul><p>一つずつ簡単に紹介します。</p><h2 id=適当な-compute-instance-から定期実行する>適当な Compute Instance から定期実行する</h2><p>こちらは、特に解説不要かな、、cron でも書いて適当に叩いてください。</p><h2 id=oci-monitoring-の-health-check-機能を使用する>OCI Monitoring の Health Check 機能を使用する</h2><h3 id=health-check-のエンドポイントを持つ-functions-を作成する>Health Check のエンドポイントを持つ Functions を作成する</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>fn init --runtime java11 fn-hello
</code></pre></div><p>一つの Functions に対して、API Gateway でエンドポイントを複数作成し、そのパスで分岐処理するパターンです。<br>今回は、</p><ul><li><code>/cold/hello</code>: Hello, world という文字列を返却するエンドポイント</li><li><code>/cold/health</code>: 定期実行用の常に<code>{"status": "UP"}</code>を返却するエンドポイント</li></ul><p>といった形で作ってみました。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>package</span> com.example.fn<span style=color:#f92672>;</span>

<span style=color:#f92672>import</span> com.fnproject.fn.api.httpgateway.HTTPGatewayContext<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HelloFunction</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String HEALTH_CHECK_URL <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/cold/health&#34;</span><span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HealthCheckResult</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>public</span> HealthStatus status<span style=color:#f92672>;</span>

        <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>HealthCheckResult</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
            <span style=color:#75715e>// default constructor.
</span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>

        <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>HealthCheckResult</span><span style=color:#f92672>(</span>HealthStatus status<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>status</span> <span style=color:#f92672>=</span> status<span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>enum</span> HealthStatus <span style=color:#f92672>{</span>
        UP<span style=color:#f92672>,</span> DOWN
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>handleRequest</span><span style=color:#f92672>(</span>HTTPGatewayContext httpGatewayContext<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> HEALTH_CHECK_URL<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>httpGatewayContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getRequestURL</span><span style=color:#f92672>())</span>
                <span style=color:#f92672>?</span> healthCheck<span style=color:#f92672>()</span>
                <span style=color:#f92672>:</span> hello<span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>hello</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Hello, world!!&#34;</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> HealthCheckResult <span style=color:#a6e22e>healthCheck</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#75715e>// always return &#34;UP&#34;
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> HealthCheckResult<span style=color:#f92672>(</span>HealthStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>UP</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>作った Functions をデプロイします。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>fn --verbose deploy --app &lt;your-app-name&gt;
</code></pre></div><h3 id=api-gateway>API Gateway</h3><p>こちらは、同一 Functions に対し、以下のようにルーティングを二つ設定します。</p><ul><li>ルーティング 1<ul><li>パス: <code>/hello</code></li><li>メソッド: GET</li><li>タイプ: Oracle Functions</li><li>アプリケーション、機能名: 自分で作成したアプリケーションの名前と関数名を指定する</li></ul></li><li>ルーティング 2<ul><li>パス: <code>/health</code></li><li>メソッド: GET</li><li>タイプ: Oracle Functions</li><li>アプリケーション、機能名: ルーティング 1 で指定したものと同じアプリケーション、関数名を指定する</li></ul></li></ul><h3 id=monitoring-の設定>Monitoring の設定</h3><p>こちらは、OCI Monitoring の持つ Health Check 機能を使用して、API Gateway 経由で公開されている Functions のエンドポイントを定期的に実行するというものです。<br>OCI コンソールから <strong>モニタリング</strong> > <strong>ヘルス・チェック</strong>と選択する。</p><p><img src=https://shukawam.github.io/blog/img/2021/0408/image01.png alt=image01></p><p><strong>ヘルス・チェックの作成</strong>を押します。</p><p><img src=https://shukawam.github.io/blog/img/2021/0408/image02.png alt=image02></p><p>以下のように入力し、ヘルス・チェックを作成します。</p><p><img src=https://shukawam.github.io/blog/img/2021/0408/image03.png alt=image03></p><ul><li>ヘルス・チェック名: functions-health-check</li><li>ターゲット: API Gateway のホスト名</li><li>バンテージ・ポイント: AWS Central EU1, Azure North Europe, Google West US</li><li>プロトコル: HTTPS</li><li>ポート: 443</li><li>パス: <code>/cold/health</code>(API Gateway に設定した Functions の Health Check 用のエンドポイント)</li><li>メソッド: GET</li><li>タイムアウト: 30 秒</li><li>間隔: 10 分</li></ul><p>ヘルス・チェックの履歴を見た際に可用性が使用可能となっていれば OK です。</p><p><img src=https://shukawam.github.io/blog/img/2021/0408/image04.png alt=image04></p><h1 id=終わりに>終わりに</h1><p>いかがでしたでしょうか。今回紹介した Functions 内に複数機能を持つような設計は複数機能での Cold Start を避けるという意味では非常に理にかなった設計となります。だからと言って、全ての機能を単一の関数内に閉じ込めると今度は、コンテナイメージが大きくなりすぎてしまい、イメージのプルに時間がかかってしまうなどの問題もあるのでバランスを見ながら設計していく必要があります。</p><h1 id=参考>参考</h1><ul><li><a href=https://technology.amis.nl/oracle-cloud/using-oci-monitoring-healthchecks-to-schedule-execution-of-serverless-functions-on-oracle-cloud-infrastructure/>Using OCI Monitoring Healthchecks to Schedule execution of Serverless Functions on Oracle Cloud Infrastructure</a></li></ul></div><div class=post-footer></div></article></main></body></html>