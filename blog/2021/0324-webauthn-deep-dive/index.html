<!doctype html><html lang=ja><head><meta charset=utf-8><title>WebAuthn DeepDive #1 - navigator.credentials.create() - Shukawam's Daily Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon sizes=180x180 href="/blog/favicon/apple-touch-icon.png?v=1"><link rel=icon type=image/png sizes=32x32 href="/blog/favicon/favicon-32x32.png?v=1"><link rel=icon type=image/png sizes=16x16 href="/blog/favicon/favicon-16x16.png?v=1"><link rel=manifest href="/blog/favicon/site.webmanifest?v=1"><link rel=mask-icon href="/blog/favicon/safari-pinned-tab.svg?v=1" color=#ffffff><link rel="shortcut icon" href="/blog/favicon/favicon.ico?v=1"><meta name=msapplication-config content="/blog/favicon/browserconfig.xml?v=1"><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><meta name=generator content="Hugo 0.74.2"><meta property="og:site_name" content="Shukawam's Daily Blog"><meta property="og:title" content="WebAuthn DeepDive #1 - navigator.credentials.create()"><meta property="og:description" content="Shukawam's Daily Blog."><meta property="description" content="Shukawam's Daily Blog."><meta property="og:url" content="https://shukawam.github.io/blog/blog/2021/0324-webauthn-deep-dive/"><meta property="og:type" content="article"><meta property="og:image" content="https://shukawam.github.io/blog/img/2021/0323/webauthn1-960x480.png"><meta property="og:image:alt" content="webauthn"><link rel=stylesheet href=/blog/css/bundle.min.d9e04ae08c9b3049b766dbd4aeab7d862c5ea1d13679b621490e0f5df5507497.css integrity="sha256-2eBK4IybMEm3ZtvUrqt9hixeodE2ebYhSQ4PXfVQdJc="><link rel=stylesheet href=/blog/css/add-on.css></head><body><header id=site-header><nav id=site-nav><h1 class=nav-title><a href=/blog/ class=nav>ブログ</a></h1><menu id=site-nav-menu class="flyout-menu menu"><a href=/blog/ class="nav link"><i class="fa fa-home"></i>Home</a>
<a href=#share-menu class="nav link share-toggle"><i class="fas fa-share-alt">&nbsp;</i>Share</a>
<a href=#search-input class="nav link search-toggle"><i class="fas fa-search">&nbsp;</i>Search</a></menu>
<a href=#search-input class="nav search-toggle"><i class="fas fa-search fa-2x">&nbsp;</i></a>
<a href=#share-menu class="nav share-toggle"><i class="fas fa-share-alt fa-2x">&nbsp;</i></a>
<a href=#lang-menu class="nav lang-toggle" lang=ja>ja</a>
<a href=#site-nav class="nav nav-toggle"><i class="fas fa-bars fa-2x"></i></a></nav><menu id=search class=menu><input id=search-input class="search-input menu"></input><div id=search-results class="search-results menu"></div></menu><menu id=lang-menu class="flyout-menu menu"><a href=# lang=ja class="nav link active">日本語 (ja)</a></menu>
<menu id=share-menu class="flyout-menu menu"><h1>Share Post</h1><a href="//twitter.com/share?text=WebAuthn%20DeepDive%20%231%20-%20navigator.credentials.create%28%29&url=https%3a%2f%2fshukawam.github.io%2fblog%2fblog%2f2021%2f0324-webauthn-deep-dive%2f" target=_blank rel=noopener class="nav share-btn twitter"><p>Twitter</p></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fshukawam.github.io%2fblog%2fblog%2f2021%2f0324-webauthn-deep-dive%2f" target=_blank rel=noopener class="nav share-btn facebook"><p>Facebook</p></a><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fshukawam.github.io%2fblog%2fblog%2f2021%2f0324-webauthn-deep-dive%2f&title=WebAuthn%20DeepDive%20%231%20-%20navigator.credentials.create%28%29" target=_blank rel=noopener class="nav share-btn linkedin"><p>LinkedIn</p></a></menu></header><div id=wrapper><section id=site-intro><a href=/blog/><img src=https://shukawam.github.io/blog/img/main/shukawam.jpg class=circle width=100 alt="Shuhei, Kawamura"></a><header><h1>Shuhei, Kawamura</h1></header><main><p>Solutions Engineer at @Oracle_Japan.</p></main><footer><ul class=socnet-icons><li><a href=//github.com/shukawam target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//twitter.com/shukawam target=_blank rel=noopener title=Twitter class="fab fa-twitter"></a></li></ul></footer></section><main id=site-main><article class=post><header><div class=title><h2><a href=/blog/blog/2021/0324-webauthn-deep-dive/>WebAuthn DeepDive #1 - navigator.credentials.create()</a></h2></div><div class=meta><time datetime="2021-03-24 00:00:00 +0000 UTC">2021-03-24</time><p>Shuhei, Kawamura</p><p>3 分で読めます</p></div></header><div id=socnet-share><a href="//twitter.com/share?text=WebAuthn%20DeepDive%20%231%20-%20navigator.credentials.create%28%29&url=https%3a%2f%2fshukawam.github.io%2fblog%2fblog%2f2021%2f0324-webauthn-deep-dive%2f" target=_blank rel=noopener class="nav share-btn twitter"><p>Twitter</p></a><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fshukawam.github.io%2fblog%2fblog%2f2021%2f0324-webauthn-deep-dive%2f" target=_blank rel=noopener class="nav share-btn facebook"><p>Facebook</p></a><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fshukawam.github.io%2fblog%2fblog%2f2021%2f0324-webauthn-deep-dive%2f&title=WebAuthn%20DeepDive%20%231%20-%20navigator.credentials.create%28%29" target=_blank rel=noopener class="nav share-btn linkedin"><p>LinkedIn</p></a></div><div class=content><a href=/blog/blog/2021/0324-webauthn-deep-dive/ class=image style="--bg-image: url('https://shukawam.github.io/blog/img/2021/0323/webauthn1-960x480.png')"><img src=https://shukawam.github.io/blog/img/2021/0323/webauthn1-960x480.png alt=webauthn></a><h1 id=始めに>始めに</h1><p><a href=https://webauthn.io/>WebAuthn</a> について学習したときのメモ。今回は、<a href=https://webauthn.io/>WebAuthn</a>よりも CTAP の話が多めかも。</p><h1 id=deep-dive>Deep Dive</h1><p>この辺の仕様を読んでいく。</p><p><img src=https://shukawam.github.io/blog/img/2021/0323/WebAuthn_Registration_r4.png alt=regist></p><p>※図は<a href=https://developer.mozilla.org/ja/docs/Web/API/Web_Authentication_API>https://developer.mozilla.org/ja/docs/Web/API/Web_Authentication_API</a>から参照</p><p>全体の流れとしては、</p><ol start=2><li><code>navigator.credentials.create()</code>が実行される<ul><li><code>authenticatorMakeCredential()</code>を実行するためのパラメータを組み立てる</li></ul></li><li>認証器の<code>authenticatorMakeCredential()</code>が呼び出される</li><li><code>authenticatorMakeCredential()</code>を実行した結果がブラウザに返される</li></ol><p>となっています。WebAuthn が実行され、認証器の<code>authenticatorMakeCredential()</code>が呼び出される所から順番に見ていきます。</p><h2 id=2-navigatorcredentialscreateの実行>2. <code>navigator.credentials.create()</code>の実行</h2><p><code>navigator.credentials.create()</code>が呼び出されると、認証器の<code>authenticatorMakeCredential()</code>を実行するためのパラメータを組み立てて実行します。その際、<code>authenticatorMakeCredential()</code>実行のために必要なパラメータの仕様は、<a href=https://fidoalliance.org/specs/fido-v2.0-id-20180227/fido-client-to-authenticator-protocol-v2.0-id-20180227.html#authenticatorMakeCredential>こちら</a>に公開されています。一部抜粋して読んでいきたいと思います。(ひとまず今回は、<strong>Required</strong> のものだけ確認していきます)</p><table><thead><tr><th>パラメータ名</th><th>型</th><th>概要</th></tr></thead><tbody><tr><td>clientDataHash</td><td>Byte Array</td><td>clientData のハッシュ</td></tr><tr><td>rp</td><td>PublicKeyCredentialRpEntity</td><td>Relying Party の情報</td></tr><tr><td>user</td><td>PublicKeyCredentialUserEntity</td><td>新しく生成する Credential に紐づくユーザーの情報</td></tr><tr><td>pubKeyCredParams</td><td>CBOR Array</td><td>生成する Credential のパラメータ(type: <code>public-key</code>で固定, alg: 公開鍵の暗号化アルゴリズム)</td></tr></tbody></table><h3 id=clientdatahash>clientDataHash</h3><blockquote><p>Hash of the ClientData contextual binding specified by host. See [WebAuthN].</p></blockquote><p>clientData のハッシュ&mldr;これだけ言われても、正直意味が分からないですが、<a href=https://fidoalliance.org/specs/fido-v2.0-id-20180227/fido-client-to-authenticator-protocol-v2.0-id-20180227.html#biblio-webauthn>WebAuthN</a>を見ろとの事なので見てみます。</p><blockquote><p>This attribute, inherited from AuthenticatorResponse, contains the JSON-compatible serialization of client data (see § 6.5 Attestation) passed to the authenticator by the client in order to generate this credential. The exact JSON serialization MUST be preserved, as the hash of the serialized client data has been computed over it.</p></blockquote><p>Credential(パスワードや生体情報などユーザ認証に必要な情報)を生成するのに必要なクライアントデータが JSON 互換のシリアライズされたものだそう。<a href=https://www.w3.org/TR/webauthn/#collectedclientdata-json-compatible-serialization-of-client-data>JSON-compatible serialization of client data</a>をもう少し見てみましょう。</p><blockquote><p><strong>JSON-compatible serialization of client data</strong>
This is the result of performing the JSON-compatible serialization algorithm on the CollectedClientData dictionary.</p></blockquote><p><a href=https://www.w3.org/TR/webauthn/#dictdef-collectedclientdata>CollectedClientData</a>がシリアライズされたものだという事が分かりました。<a href=https://www.w3.org/TR/webauthn/#dictdef-collectedclientdata>CollectedClientData</a> は以下のようになっています。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt>dictionary CollectedClientData {
    required DOMString           type;
    required DOMString           challenge;
    required DOMString           origin;
    boolean                      crossOrigin;
    TokenBinding                 tokenBinding;
};

dictionary TokenBinding {
    required DOMString status;
    DOMString id;
};

enum TokenBindingStatus { &#34;present&#34;, &#34;supported&#34; };
</code></pre></div><p>ここでも Required のプロパティのみ見ていきます。</p><table><thead><tr><th>パラメータ名</th><th>型</th><th>概要</th></tr></thead><tbody><tr><td>type</td><td>DOMString</td><td>Credential を生成するときは<code>webauthn.create</code>、取得するときには<code>webauthn.get</code>が固定値で設定される</td></tr><tr><td>challenge</td><td>DOMString</td><td>Relying Party で生成された challenge(16 バイト以上のランダムバッファー)が base64url エンコードされたものが設定される</td></tr><tr><td>origin</td><td>DOMString</td><td>クライアントの origin(e.g. <a href=http://localhost:4200>http://localhost:4200</a>)が設定される</td></tr></tbody></table><p>ということで、<code>authenticatorMakeCredential()</code>が実行されるときには以下のようなデータがシリアライズされて渡されるみたいです。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt>{
  &#34;type&#34;: &#34;webauthn.create&#34;,
  &#34;challenge&#34;: &#34;xTzphZPuJyfW12TAT…&#34;,
  &#34;origin&#34;: &#34;https://example.com&#34;
}
</code></pre></div><p>ちなみに、シリアライズするときの手順はこちら(<a href=https://www.w3.org/TR/webauthn/#clientdatajson-serialization>5.8.1.1. Serialization</a>)に記されております。</p><h3 id=rp>rp</h3><blockquote><p>This PublicKeyCredentialRpEntity data structure describes a Relying Party with which the new public key credential will be associated. It contains the Relying party identifier, (optionally) a human-friendly RP name, and (optionally) a URL referencing a RP icon image. The RP name is to be used by the authenticator when displaying the credential to the user for selection and usage authorization.</p></blockquote><p>とのことで、Relying Party の情報が含まれているデータのようです。最終的には、以下のようなデータが渡されます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt>{
  // Required
  &#34;id&#34;: &#34;example.com&#34;, // Relying Partyを識別するID
  // Optionally
  &#34;name&#34;: &#34;Relying Party Example&#34;, // Relying Partyの名前
  &#34;icon&#34;: &#34;https://example.com/...&#34; // アイコンイメージが格納されている場所をURLで指定する
}
</code></pre></div><p><code>navigator.credentials.create()</code>の実行時に渡したパラメータがそのまま渡されるようです。</p><h3 id=user>user</h3><blockquote><p>This PublicKeyCredentialUserEntity data structure describes the user account to which the new public key credential will be associated at the RP. It contains an RP-specific user account identifier, (optionally) a user name, (optionally) a user display name, and (optionally) a URL referencing a user icon image (of a user avatar, for example). The authenticator associates the created public key credential with the account identifier, and MAY also associate any or all of the user name, user display name, and image data (pointed to by the URL, if any).</p></blockquote><p>とのことで、新しい公開鍵 Credential が紐づけられるユーザーの情報が含まれます。最終的には、以下のようなデータが渡されます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt>{
  // Required
  &#34;id&#34;: BufferSource, // ユーザーを一意に識別するID
  // Optionally
  &#34;displayName&#34;: &#34;John P. Smith&#34;, // 表示名
  &#34;name&#34;: &#34;john.p.smith@example.com&#34; // ユーザー名
}
</code></pre></div><p><code>navigator.credentials.create()</code>の実行時に渡したパラメータがそのまま渡されるようです。</p><h3 id=pubkeycredparams>pubKeyCredParams</h3><blockquote><p>A sequence of CBOR maps consisting of pairs of PublicKeyCredentialType (a string) and cryptographic algorithm (a positive or negative integer), where algorithm identifiers are values that SHOULD be registered in the IANA COSE Algorithms registry [IANA-COSE-ALGS-REG]. This sequence is ordered from most preferred (by the RP) to least preferred.</p></blockquote><p>Credential のタイプと署名のアルゴリズムを指定する項目となっています。最終的には、以下のようなデータが渡されます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt>[
  {
    &#34;alg&#34;: -7,
    &#34;type&#34;: &#34;public-key&#34;
  }
  //...
]
</code></pre></div><p><code>navigator.credentials.create()</code>の実行時に渡したパラメータがそのまま渡されるようです。</p><h2 id=4-authenticatormakecredentialを実行した結果>4. <code>authenticatorMakeCredential()</code>を実行した結果</h2><p><code>authenticatorMakeCredential()</code>を実行すると以下のようなデータがブラウザ(JavaScript Application)に返却されます。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt>{
  &#34;id&#34;: &#34;xTzphZPuJyfW12TAT…&#34;,
  &#34;rawId&#34;: ArrayBuffer(64) {},
  &#34;response&#34;: {
    &#34;attestationObject&#34;: ArrayBuffer(1024),
    &#34;clientDataJSON&#34;: ArrayBuffer(116) {}
  },
  &#34;type&#34;: &#34;public-key&#34;
}
</code></pre></div><p>それぞれのプロパティを見ていきましょう。</p><table><thead><tr><th>パラメータ名</th><th>概要</th></tr></thead><tbody><tr><td>id</td><td>rawId を base64url エンコードしたもの</td></tr><tr><td>rawId</td><td>Credential 毎に一意に定められている</td></tr><tr><td>attestationObject</td><td>認証用の公開鍵や CredentialID、署名などが含まれている</td></tr><tr><td>clientDataJSON</td><td>challenge, oritin, type などが含まれている clientData を JSON シリアライズしたもの(ref: <a href=#clientDataHash>clientDataHash</a>)</td></tr><tr><td>type</td><td><code>public-key</code>固定</td></tr></tbody></table><p>このうち、<code>attestationObject</code>, <code>clientDataJSON</code>を Relying Party へ送信し検証が成功すれば登録処理は完了です。</p><h1 id=参考>参考</h1><ul><li><a href=https://developer.mozilla.org/ja/docs/Web/API/Web_Authentication_API>Web Authentication API</a></li><li><a href=https://fidoalliance.org/specs/fido-v2.0-id-20180227/fido-client-to-authenticator-protocol-v2.0-id-20180227.html>Client to Authenticator Protocol (CTAP)</a></li></ul></div><footer><div class=stats><ul class=categories><li><a class=article-terms-link href=/blog/categories/tech/>tech</a></li></ul><ul class=tags><li><a class=article-terms-link href=/blog/tags/webauthn/>WebAuthn</a></li><li><a class=article-terms-link href=/blog/tags/ctap/>CTAP</a></li></ul></div></footer></article><article class=post><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"shukawam"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article><div class=pagination><a href=/blog/blog/2021/0404-webauthn-deep-dive/ class="button left"><span>WebAuthn DeepDive #2 - Attestation</span></a>
<a href=/blog/blog/2021/0322-spring-boot-native-image/ class="button right"><span>Spring Native Getting Started</span></a></div></main><section id=site-sidebar><section id=recent-posts><header><h1>最近の投稿</h1></header><article class=mini-post><a href=/blog/blog/2021/0404-webauthn-deep-dive/ class=image style="--bg-image: url('https://shukawam.github.io/blog/img/2021/0323/webauthn1-960x480.png')"><img src=https://shukawam.github.io/blog/img/2021/0323/webauthn1-960x480.png alt=webauthn></a><header><h2><a href=/blog/blog/2021/0404-webauthn-deep-dive/>WebAuthn DeepDive #2 - Attestation</a></h2><time class=published datetime="2021-04-05 00:00:00 +0000 UTC">2021-04-05</time></header></article><article class=mini-post><a href=/blog/blog/2021/0324-webauthn-deep-dive/ class=image style="--bg-image: url('https://shukawam.github.io/blog/img/2021/0323/webauthn1-960x480.png')"><img src=https://shukawam.github.io/blog/img/2021/0323/webauthn1-960x480.png alt=webauthn></a><header><h2><a href=/blog/blog/2021/0324-webauthn-deep-dive/>WebAuthn DeepDive #1 - navigator.credentials.create()</a></h2><time class=published datetime="2021-03-24 00:00:00 +0000 UTC">2021-03-24</time></header></article><article class=mini-post><a href=/blog/blog/2021/0322-spring-boot-native-image/ class=image style="--bg-image: url('https://shukawam.github.io/blog/img/2021/0323/OG-Spring.png')"><img src=https://shukawam.github.io/blog/img/2021/0323/OG-Spring.png alt></a><header><h2><a href=/blog/blog/2021/0322-spring-boot-native-image/>Spring Native Getting Started</a></h2><time class=published datetime="2021-03-22 00:00:00 +0000 UTC">2021-03-22</time></header></article><article class=mini-post><a href=/blog/blog/2021/0212-helidon-se-components/ class=image style="--bg-image: url('https://shukawam.github.io/blog/img/2021/0206/helidon.jpg')"><img src=https://shukawam.github.io/blog/img/2021/0206/helidon.jpg alt=helidon.jpg></a><header><h2><a href=/blog/blog/2021/0212-helidon-se-components/>Helidon SE Component - Config, OpenAPI</a></h2><time class=published datetime="2021-02-08 00:00:00 +0000 UTC">2021-02-08</time></header></article><article class=mini-post><a href=/blog/blog/2021/0206-helidon-se-get-started/ class=image style="--bg-image: url('https://shukawam.github.io/blog/img/2021/0206/helidon.jpg')"><img src=https://shukawam.github.io/blog/img/2021/0206/helidon.jpg alt=helidon.jpg></a><header><h2><a href=/blog/blog/2021/0206-helidon-se-get-started/>Helidon SE Get Started</a></h2><time class=published datetime="2021-02-07 00:00:00 +0000 UTC">2021-02-07</time></header></article><footer><a href=/blog/blog class=button>続きを見る</a></footer></section><section id=categories><header><h1><a href=/blog/categories>カテゴリー</a></h1></header><ul><li><a href=/blog/categories/tech/>tech<span class=count>7</span></a></li></ul></section></section><footer id=site-footer><ul class=socnet-icons><li><a href=//github.com/shukawam target=_blank rel=noopener title=GitHub class="fab fa-github"></a></li><li><a href=//twitter.com/shukawam target=_blank rel=noopener title=Twitter class="fab fa-twitter"></a></li></ul><p class=copyright>© 2021 Shukawam's Daily Blog<br>Theme: <a href=https://github.com/pacollins/hugo-future-imperfect-slim target=_blank rel=noopener>Hugo Future Imperfect Slim</a><br>A <a href=https://html5up.net/future-imperfect target=_blank rel=noopener>HTML5 UP port</a> | Powered by <a href=https://gohugo.io/ title=0.74.2 target=_blank rel=noopener>Hugo</a></p></footer><a id=back-to-top href=# class="fas fa-arrow-up fa-2x"></a><script src=/blog/js/highlight.js></script><script>hljs.initHighlightingOnLoad();</script><script src=/blog/js/bundle.min.9ff362e34d745f104d2d4c4f7cc44e803472c83258fff84852e7d418014b25c3.js integrity="sha256-n/Ni4010XxBNLUxPfMROgDRyyDJY//hIUufUGAFLJcM="></script><script src=/blog/js/add-on.js></script></div></body></html>